; Auto-generated by chef for <%= @node[:fqdn] %>
$TTL    300	; 300 seconds == 5 minutes
$ORIGIN lockerz.int.
@               IN SOA  @       root (
                                        <%= @serial %>  ; serial
                                        3H              ; refresh
                                        15M             ; retry
                                        1W              ; expiry
                                        1M )            ; negative cache TTL RFC2308

<% @nameservers.each do |ns| -%>
		NS <%= ns['fqdn'].split(".")[0...-2].join(".") %>.lockerz.int.
<% end -%>

<% @hosts.each do |host| -%>
<% Chef::Log.warn("Host is %s"%host) -%>
<% Chef::Log.warn("Host[fqdn] is %s"%host['fqdn']) -%>
<% Chef::Log.warn("Host[ipaddress] is %s"%host['ipaddress']) -%>
<% if not host['fqdn'] =~ /^[0-9a-zA-z.-]+$/ -%>
<%  if host.key?('fqdn') and not (host['fqdn'].nil? or host['fqdn'].empty? ) -%>
<%   Chef::Log.warn("%s FQDN %s contains illegal characters"%[host, host['fqdn']]) -%>
<%  else -%>
<%   Chef::Log.warn("%s FQDN is missing or empty"%host) -%>
<%  end -%>
<% next -%>
<% end -%>
<% if host['ipaddress']  && host['fqdn'] && host['fqdn'] =~ /\.lockerz\.(us|int)$/ -%> 
<%= host['fqdn'].split(".")[0...-2].join(".") %>	A <%= host['ipaddress'] %>
<% if host['ec2'] -%>
		TXT "id=<%= host['ec2']['instance_id'] %> type=<%=host['ec2']['instance_type'] %>"
<% if host['ec2']['userdata'] -%> <%# using userdata for this is a bad hack anyway should get it from the node's properties -%>
<% ud=JSON.parse(host['ec2']['userdata']) -%>
<% if ud['envName'] && ud['stackName'] && ud['roleName'] -%>
<%= ud['roleName'] + "." + ud['stackName'] + "." + ud['envName'] %>	A <%= host['ipaddress'] %>
<% end -%> <%# if ud... -%>
<% end -%> <%# if ec2 userdata -%>
<% end -%> <%# if ec2 -%>
<% end -%> <%# if host... -%>
<% if host['dns'] && host['dns']['aliases'] -%>
<% host['dns']['aliases'].each do |al| -%>
<%= al %>	A <%= host['ipaddress'] %>
<% end -%> <%# each do aliases -%>
<% end -%> <%# if aliases -%>
<% if host['dns'] && host['dns']['cnames'] -%>
<% host['dns']['cnames'].each do |cn| -%>
<% if host['fqdn'] =~ /\.lockerz\.us$/ -%>
<%= cn %>	CNAME <%= host['fqdn'].split(".")[0...-2].join(".") %>
<% else -%>
<%= cn %>	CNAME <%= host['fqdn'] %>.
<% end -%> <%# if fqdn -%>
<% end -%> <%# each do cnames -%>
<% end -%> <%# if cnames -%>
<% end -%> <%# each do hosts -%>
